<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado de Participantes - Estudio CÃ¡ncer GÃ¡strico</title>
    <link rel="stylesheet" href="style.css">
    <style>
        nav button {
            color: white;
            background: none;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 1rem;
        }
        nav button:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<header>
    <h1>ğŸ‘¥ Listado de Participantes</h1>
</header>

<nav>
    <a href="encuesta.html">ğŸ“ Realizar Encuesta</a>
    <a href="listaParticipantes.html">ğŸ“ˆ Lista de participantes</a>
    <a href="preguntas.html">â“ GestiÃ³n de preguntas</a>
    <button id="logoutBtn">ğŸ”“ Cerrar sesiÃ³n</button>
</nav>

<main>
    <h2>Participantes Registrados</h2>

    <table id="tablaParticipantes">
        <thead>
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>RUT</th>
            <th>Sexo</th>
            <th>Peso</th>
            <th>Email</th>
            <th>Tipo</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</main>

<script>
    // --- CONTROL DE SESIÃ“N ---
    const usuario = sessionStorage.getItem("usuario");
    if (!usuario) {
        alert("Debes iniciar sesiÃ³n para acceder a esta pÃ¡gina");
        window.location.href = "login.html";
    }
    const usuarioObj = JSON.parse(usuario);

    // --- LOGOUT ---
    document.querySelector("#logoutBtn").addEventListener("click", () => {
        sessionStorage.removeItem("usuario");
        alert("âœ… Has cerrado sesiÃ³n");
        window.location.href = "login.html";
    });

    // --- API PARTICIPANTES ---
    const apiUrl = "/api/participantes";
    let participantesCache = [];

    async function cargarParticipantes() {
        const tbody = document.querySelector("#tablaParticipantes tbody");
        tbody.innerHTML = "";

        try {
            const res = await fetch(apiUrl);

            if (res.status === 401) {
                tbody.innerHTML = `<tr><td colspan="8" style="color:red; text-align:center;">
                    âŒ Debes iniciar sesiÃ³n para ver los participantes
                </td></tr>`;
                return;
            }

            if (res.status === 403) {
                tbody.innerHTML = `<tr><td colspan="8" style="color:red; text-align:center;">
                    âŒ No estÃ¡s autorizado para ver los datos de los participantes
                </td></tr>`;
                return;
            }

            participantesCache = await res.json();
            if (participantesCache.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No hay participantes registrados</td></tr>`;
                return;
            }

            participantesCache.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${p.idParticipante}</td>
                    <td>${p.nombre}</td>
                    <td>${p.rut}</td>
                    <td>${p.sexo}</td>
                    <td>${p.peso ?? "-"}</td>
                    <td>${p.email ?? "-"}</td>
                    <td>${p.esCaso ? "Caso" : "Control"}</td>
                    <td class="acciones">
                        <button onclick="ver('${p.idParticipante}')">ğŸ‘ï¸ Ver</button>
                        <button onclick="editar('${p.idParticipante}')">âœï¸ Editar</button>
                        <button onclick="eliminar('${p.idParticipante}')">ğŸ—‘ï¸ Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="8" style="color:red; text-align:center;">
                âŒ Error al cargar los participantes
            </td></tr>`;
            console.error(err);
        }
    }

    function editar(id) {
        window.location.href = `encuesta.html?id=${id}`;
    }

    function ver(id) {
        window.location.href = `verRespuestas.html?id=${id}`;
    }

    async function eliminar(id) {
        if (!confirm("Â¿Seguro que deseas eliminar este participante?")) return;
        await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
        await cargarParticipantes();
    }

    cargarParticipantes();
</script>

</body>
</html>
